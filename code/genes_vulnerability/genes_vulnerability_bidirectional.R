# to exclude data from time point(s), edit: line 31 (vuln file name), 80, 86 (file names to save)

#################
### Load data ###
#################

rm(list=setdiff(ls(),c('params','measure', 'injection.site')))
print(measure)
basedir <- params$basedir
setwd(basedir)
savedir <- paste(params$opdir,'genes_vulnerability/',paste0(injection.site,collapse='-'),'/',sep='')
dir.create(savedir,recursive=T)

source('code/misc/fitfxns.R')
source('code/misc/optimfxns.R')
source('code/misc/miscfxns.R')
source('code/misc/plottingfxns.R')
source('code/misc/normfuns.R')

load(paste0(params$opdir,'processed/',measure,'data.RData'))  # load path data and ROI names

r.method <- 'pearson' # set method for correlation

##########################
### load vulnerability ###
##########################

vuln.dir <- paste(params$opdir,'diffmodel/bidirectional_onelm/',paste0(injection.site,collapse='-'),'/',sep='')
df.vuln <- read.csv(paste0(vuln.dir,measure,'_vulnerability_bidirectional_hemiaverage_1.3.6.9.MPI.csv'),row.names = 1) # load in data averaged over 1, 3, 6, 9 MPI tps

#################################
### load gene expression data ###
#################################

df.gene <- read.csv(paste0(params$opdir,'processed/norm_avg_Pangea_exp.csv'), row.names = 1)

region.names <- row.names(df.gene)
df.vuln <-as.data.frame(df.vuln[region.names,], row.names = region.names) # order regions in vulnerability to match gene expression data
colnames(df.vuln)[1] <- 'v'

# normalize gene expression and vulnerability data using rank inverse normal transformation -- https://www.nature.com/articles/ejhg2015270
df.gene <- rank_INT(df.gene)
df.vuln <- rank_INT(df.vuln)

####################################################################
### simple correlation between gene expression and vulnerability ###
####################################################################

gene.names <- colnames(df.gene)
r.gene.vuln <- lapply(gene.names, function(g) cor.test(df.vuln$v,df.gene[,g],
                                                       use = 'pairwise.complete.obs',
                                                       method =r.method))
r.gene.vuln.r <- sapply(r.gene.vuln, function(X) unname(X$estimate))
r.gene.vuln.p <- sapply(r.gene.vuln, function(X) unname(X$p.value))

r.gene.vuln.p.bonf <- p.adjust(r.gene.vuln.p,method='bonferroni')
r.gene.vuln.p.fdr <- p.adjust(r.gene.vuln.p,method = 'fdr')

ord <- order(abs(r.gene.vuln.r),decreasing = T) # gives order of strength of association with vulnerability

# write out list of r and p values for all genes
names(r.gene.vuln.r) <- gene.names # applies gene names to list of r values
n <- length(r.gene.vuln.r)
df.res <- data.frame(gene=names(r.gene.vuln.r)[ord][1:n], r=r.gene.vuln.r[ord][1:n],p_bonf=r.gene.vuln.p.bonf[ord][1:n],p_fdr=r.gene.vuln.p.fdr[ord][1:n],p_un=r.gene.vuln.p[ord][1:n])
write.csv(x=df.res,file = paste0(savedir,measure,'AllGenesVulnerability_1.3.6.9.MPI_',r.method,'.csv'), row.names = FALSE) # _excl_0.5MPI

# write out list of r and p values for only genes with FDR-corrected p < 0.05
genes.vuln.related <- names(r.gene.vuln.r)[r.gene.vuln.p.fdr<0.05] # pull out list of genes w/FDR-corrected p-val < 0.05
n <- length(genes.vuln.related) # how many genes have FDR-corrected p-val < 0.05  
df.res <- data.frame(gene=names(r.gene.vuln.r)[ord][1:n], r=r.gene.vuln.r[ord][1:n],p_bonf=r.gene.vuln.p.bonf[ord][1:n],p_fdr=r.gene.vuln.p.fdr[ord][1:n],p_un=r.gene.vuln.p[ord][1:n])
write.csv(x=df.res,file = paste0(savedir,measure,'Top',n,'GenesVulnerability_1.3.6.9.MPI_',r.method,'.csv'), row.names = FALSE) # _excl_0.5MPI

if(length(genes.vuln.related)>0){
  gene.r.mat <- cor(df.gene[,genes.vuln.related],use = 'pairwise.complete.obs',method = 'pearson')
  hc <- hclust(as.dist(1-gene.r.mat)) # simple hierarchical clustering to group genes by similarity
  p <- imagesc(gene.r.mat[hc$order,hc$order],cmap = 'BrBG',clim = c(-1,1),caxis_name = 'r') + coord_equal()+ 
    theme(axis.text.x=element_text(angle=90,vjust=0.5,hjust=1)) +
    ggtitle('Spatial Similarity of Expression Patterns\nFor Vulnerability-Related Genes') + theme(plot.title = element_text(hjust=0.5)) +
    nice_cbar()
  ggsave(p,filename = paste0(savedir,measure,'SimilarityOfVulnerabilityRelatedGenes',r.method,'.pdf'),
         units = 'cm',height = 6,width = 6,useDingbats=FALSE)
}

# create correlation plots for the 10 genes that show the strongest positive correlations with regional vulnerability:
pos_r <- df.res %>%
  filter(r > 0)
top10_pos_r <- pos_r[1:10,]
top10_pos_genes.vuln <- top10_pos_r$gene
top10_pos.list <- lapply(top10_pos_genes.vuln, function(g) p.xy.flex(x=df.gene[,g],y=df.vuln$v,
                                                           xlab = g,ylab='Vulnerability',ptxt = 'p[FDR] == ',parse = T,rtxt = 'r == ',
                                                  ttl = '',alpha = 0.8,col = wes_palettes$BottleRocket1[6],p=df.res[g,'p_fdr'],pos = 'top.right',r.method = r.method))
p.pos.all <- plot_grid(plotlist = top10_pos.list,ncol=5,nrow=2)
ggsave(p.pos.all,filename = paste(savedir,measure,'_pos_top10_VulnerabilityRelatedGenesFDR',r.method,'.pdf',sep=''),
       units = 'cm',height = 9,width = 18,useDingbats=FALSE)

# create correlation plots for the 10 genes that show the strongest negative correlations with regional vulnerability:
neg_r <- df.res %>%
  filter(r < 0)
top10_neg_r <- neg_r[1:10,]
top10_neg_genes.vuln <- top10_neg_r$gene
top10_neg.list <- lapply(top10_neg_genes.vuln, function(g) p.xy.flex(x=df.gene[,g],y=df.vuln$v,
                                                                     xlab = g,ylab='Vulnerability',ptxt = 'p[FDR] == ',parse = T,rtxt = 'r == ',
                                                                     ttl = '',alpha = 0.8,col = wes_palettes$BottleRocket1[6],p=df.res[g,'p_fdr'],pos = 'top.right',r.method = r.method))
p.neg.all <- plot_grid(plotlist = top10_neg.list,ncol=5,nrow=2)
ggsave(p.neg.all,filename = paste(savedir,measure,'_neg_top10_VulnerabilityRelatedGenesFDR',r.method,'.pdf',sep=''),
       units = 'cm',height = 9,width = 18,useDingbats=FALSE)

# create individual correlation plots for Snca vs vulnerability and Pak6 vs vulnerability
p.Snca <- p.xy.flex(x=df.gene[,'Snca'],y=df.vuln$v,
          xlab = 'Snca',ylab='Vulnerability',ptxt = 'p[FDR] == ',parse = T,rtxt = 'r == ',
          ttl = '',alpha = 0.8,col = wes_palettes$BottleRocket1[6],p=df.res['Snca','p_fdr'],pos = 'top.right',r.method = r.method)
ggsave(p.Snca,filename = paste0(savedir,measure,'_Snca_vs_VulnerabilityFDR',r.method,'.pdf'),
       units = 'cm',height = 4.5,width = 4.5,useDingbats=FALSE)

# create individual correlation plots for Pak6 vs vulnerability and Pak6 vs vulnerability
p.Pak6 <- p.xy.flex(x=df.gene[,'Pak6'],y=df.vuln$v,
                    xlab = 'Pak6',ylab='Vulnerability',ptxt = 'p[FDR] == ',parse = T,rtxt = 'r == ',
                    ttl = '',alpha = 0.8,col = wes_palettes$BottleRocket1[6],p=df.res['Pak6','p_fdr'],pos = 'top.right',r.method = r.method)
ggsave(p.Pak6,filename = paste0(savedir,measure,'_Pak6_vs_VulnerabilityFDR',r.method,'.pdf'),
       units = 'cm',height = 4.5,width = 4.5,useDingbats=FALSE)

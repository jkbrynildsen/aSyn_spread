### Plot correlations in model residuals across the 8 time points

library(corrplot)

rm(list=setdiff(ls(),c('params','measure', 'injection.site')))
print(measure)
basedir <- params$basedir
setwd(basedir)
savedir <- paste(params$opdir,'genes_vulnerability/',paste0(injection.site,collapse='-'),'/',sep='')
dir.create(savedir,recursive=T)

vuln.dir <- paste(params$opdir,'diffmodel/bidirectional_onelm/',paste0(injection.site,collapse='-'),'/',sep='')
df.vuln <- read.csv(paste0(vuln.dir,measure,'_vulnerability_bidirectional.csv'),row.names = 1)
df.avg_vuln <- read.csv(paste0(vuln.dir,measure,'_vulnerability_bidirectional_hemiaverage.csv'),row.names = 1)
colnames(df.avg_vuln)[1] <- 'Time_hemi_avg'

ipsi_vuln <- df.vuln[grep("^i", rownames(df.vuln)), ]
colnames(ipsi_vuln) <- c('ipsi 0.1 MPI', 'ipsi 0.2 MPI', 'ipsi 0.3 MPI', 'ipsi 0.5 MPI', 'ipsi 1 MPI', 'ipsi 3 MPI', 'ipsi 6 MPI', 'ipsi 9 MPI')
contra_vuln <- df.vuln[grep("^c", rownames(df.vuln)), ]
colnames(contra_vuln) <- c('contra 0.1 MPI', 'contra 0.2 MPI', 'contra 0.3 MPI', 'contra 0.5 MPI', 'contra 1 MPI', 'contra 3 MPI', 'contra 6 MPI', 'contra 9 MPI')

all_vuln <- cbind(ipsi_vuln, contra_vuln, df.avg_vuln)

# generate correlation matrix
all_vuln_cor <- cor(all_vuln, use="complete.obs")
# plot correlation matrix
col <- colorRampPalette(c("#4477AA", "#77AADD", "#FFFFFF", "#EE9988", "#BB4444")) # assign color spectrum
pdf(file = paste0(savedir, measure, '_SimilarityOfVulnAcrossTime.pdf'))
corrplot(all_vuln_cor, method="color", type="full", col=col(200),  
         addCoef.col = "black", number.cex= 4/ncol(all_vuln_cor), # Add coefficient of correlation
         tl.col="black", tl.srt = 90, #Text label color and angle
         diag=TRUE)
dev.off()

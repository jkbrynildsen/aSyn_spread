# Visualize distributions of gene expression and regional vulnerability data before and after normalization

rm(list=setdiff(ls(),c('params','measure', 'injection.site')))
print(measure)
basedir <- params$basedir
setwd(basedir)
savedir <- paste0(params$opdir,'genes_vulnerability/',paste0(injection.site,collapse='-'),'/')
dir.create(savedir,recursive=T)

source('code/misc/normfuns.R')

# load up vulnerability data
vuln.dir <- paste(params$opdir,'diffmodel/bidirectional_onelm/',paste0(injection.site,collapse='-'),'/',sep='')
df.vuln <- read.csv(paste0(vuln.dir,measure,'_vulnerability_bidirectional_hemiaverage.csv'),row.names = 1) # decide whether or not to exclude first time point # _excl_0.5MPI

# load gene expression data
df.raw.gene <- read.csv(paste0(params$opdir,'processed/avg_Pangea_exp.csv'), row.names = 1)

# load normalized gene expression data
df.gene <- read.csv(paste0(params$opdir,'processed/norm_avg_Pangea_exp.csv'), row.names = 1)

region.names <- row.names(df.gene)
df.vuln <-as.data.frame(df.vuln[region.names,], row.names = region.names) # order regions in vulnerability to match gene expression data
colnames(df.vuln)[1] <- 'v'

# visualize vulnerability data distribution
pv <- ggplot(df.vuln, aes(v)) + 
  geom_histogram() + ylim(0,13) +
  theme_cowplot(8)
pv
ggsave(pv,filename = paste0(savedir,measure,'_vulnerability_distribution.pdf'),
       units = 'cm',height = 3.75,width = 3.75,useDingbats=FALSE)

rank.df.vuln <- rank_INT(df.vuln) # perform rank inverse transform
# visualize vulnerability data distribution
npv <- ggplot(rank.df.vuln, aes(v)) + 
  geom_histogram() + ylim(0,13) +
  theme_cowplot(8)
npv
ggsave(npv,filename = paste0(savedir,measure,'_norm_vulnerability_distribution.pdf'),
       units = 'cm',height = 3.75,width = 3.75,useDingbats=FALSE)

# pivot raw gene expression data into single column for plotting
long.raw.gene <- df.raw.gene %>%
  pivot_longer(cols = everything(), names_to = "gene", values_to = "expression_level")

rpg <- ggplot(long.raw.gene, aes(expression_level)) + 
  geom_histogram() + #ylim(0,13) +
  theme_cowplot(8)
rpg
ggsave(rpg,filename = paste0(savedir,measure,'_raw_gene_distribution.pdf'),
       units = 'cm',height = 3.75,width = 3.75,useDingbats=FALSE)

# pivot normalized gene expression data into single column for plotting
long.gene <- df.gene %>%
  pivot_longer(cols = everything(), names_to = "gene", values_to = "expression_level")
  
spg <- ggplot(long.gene, aes(expression_level)) + 
  geom_histogram() + #ylim(0,13) +
  theme_cowplot(8)
spg
ggsave(spg,filename = paste0(savedir,measure,'_sigmoid_gene_distribution.pdf'),
       units = 'cm',height = 3.75,width = 3.75,useDingbats=FALSE)

rank.long.gene <- as.data.frame(long.gene$expression_level)
rank.long.gene <- rank_INT(rank.long.gene) # apply rank inverse transform
colnames(rank.long.gene)[1] <- 'exp'

nspg <- ggplot(rank.long.gene, aes(exp)) + 
  geom_histogram() + #ylim(0,13) +
  theme_cowplot(8)
nspg
ggsave(nspg,filename = paste0(savedir,measure,'_norm_sigmoid_gene_distribution.pdf'),
       units = 'cm',height = 3.75,width = 3.75,useDingbats=FALSE)
